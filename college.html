<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nearby Colleges Finder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  
  <style>
    #map {
      height: 400px;
      width: 100%;
      border-radius: 12px;
      margin-top: 20px;
    }
    .college-img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 10px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex flex-col">

  <!-- Navbar -->
  <nav class="w-full bg-white shadow-md p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-indigo-700">üéì Nextora - College Finder</h1>
    
    <!-- Filter Dropdown -->
    <div class="flex items-center space-x-4">
      <select id="filterOption" 
        class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-400 outline-none">
        <option value="">üîé Filter by</option>
        <option value="placement">On the basis of Placement</option>
        <option value="fees">On the basis of Fees</option>
        <option value="naac">On the basis of NAAC Accreditation</option>
        <option value="type">On the basis of College Type</option>
      </select>
      <button onclick="applyFilter()" 
        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg shadow">
        Apply
      </button>
    </div>
  </nav>

  <!-- Header -->
  <header class="text-center mt-8">
    <h2 class="text-3xl font-bold text-indigo-700">Find Nearby Colleges</h2>
    <p class="text-gray-600 mt-2">Enter your location or use your GPS to explore colleges within 200 km</p>
  </header>

  <!-- Input Section -->
  <div class="bg-white shadow-lg rounded-2xl p-6 w-full max-w-md mx-auto mt-6 space-y-3">
    <input type="text" id="locationInput" 
      class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-400 outline-none"
      placeholder="Enter your city or location">
    <button onclick="findColleges()" 
      class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg shadow">
      üîç Search by Location
    </button>
    <button onclick="useMyLocation()" 
      class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg shadow">
      üìç Use My Location
    </button>
  </div>

  <!-- Map -->
  <div id="map" class="w-full max-w-5xl mx-auto"></div>

  <!-- Results -->
  <div id="results" class="mt-8 w-full max-w-5xl mx-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>

  <script>
    let collegeData = []; 
    let map, markers = [];

    const naacGrades = ["A++", "A+", "A", "B+", "B"];
    const collegeTypes = ["Government", "Autonomous", "Private"];

    async function findColleges(location = null, lat = null, lon = null) {
      const resultsDiv = document.getElementById('results');
      if (!lat || !lon) {
        const inputLocation = location || document.getElementById('locationInput').value;
        resultsDiv.innerHTML = `<p class="text-gray-600 col-span-full text-center">‚è≥ Searching for colleges near <strong>${inputLocation}</strong>...</p>`;
        
        // Geocode text location
        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${inputLocation}`);
        const geoData = await geoRes.json();
        if (!geoData.length) {
          resultsDiv.innerHTML = `<p class="text-red-600 col-span-full text-center">‚ùå Location not found!</p>`;
          return;
        }
        lat = geoData[0].lat;
        lon = geoData[0].lon;
      }

      try {
        // Initialize / reset map
        if (!map) {
          map = L.map('map').setView([lat, lon], 9);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
        } else {
          map.setView([lat, lon], 9);
          markers.forEach(m => map.removeLayer(m));
          markers = [];
        }

        // Overpass API query
        const overpassQuery = `
          [out:json];
          node["amenity"="university"](around:200000,${lat},${lon});
          out;
        `;
        const overpassRes = await fetch("https://overpass-api.de/api/interpreter", {
          method: "POST",
          body: overpassQuery
        });
        const overpassData = await overpassRes.json();

        if (!overpassData.elements.length) {
          resultsDiv.innerHTML = `<p class="text-gray-700 col-span-full text-center">No colleges found within 200 km üò¢</p>`;
          return;
        }

        // Enrich with mock attributes
        collegeData = overpassData.elements.map(college => ({
          ...college,
          placement: Math.floor(Math.random() * 41) + 60,
          fees: Math.floor(Math.random() * 200000) + 50000,
          naac: naacGrades[Math.floor(Math.random() * naacGrades.length)],
          type: collegeTypes[Math.floor(Math.random() * collegeTypes.length)],
          image: `https://picsum.photos/400/200?random=${Math.floor(Math.random() * 1000)}`
        }));

        displayColleges(collegeData);
        addMarkers(collegeData);

      } catch (error) {
        resultsDiv.innerHTML = `<p class="text-red-600 col-span-full text-center">‚ö†Ô∏è Error fetching data.</p>`;
        console.error(error);
      }
    }

    function displayColleges(data) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = "";

      data.forEach(college => {
        const div = document.createElement("div");
        div.className = "college bg-white shadow-md rounded-xl overflow-hidden border border-gray-100 hover:shadow-xl transition";
        div.innerHTML = `
          <img src="${college.image}" alt="College Image" class="college-img">
          <div class="p-4">
            <h3 class="text-lg font-bold text-indigo-700">${college.tags.name || "Unnamed College"}</h3>
            <p class="text-gray-600 mt-2">üìç Lat: ${college.lat}, Lon: ${college.lon}</p>
            <p class="text-gray-500 text-sm mt-1">‚≠ê Placement Score: ${college.placement}%</p>
            <p class="text-gray-500 text-sm">üí∞ Avg Fees: ‚Çπ${college.fees.toLocaleString()}</p>
            <p class="text-gray-500 text-sm">üèÜ NAAC Grade: ${college.naac}</p>
            <p class="text-gray-500 text-sm">üè´ Type: ${college.type}</p>
          </div>
        `;
        resultsDiv.appendChild(div);
      });
    }

    function addMarkers(data) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      data.forEach(college => {
        const marker = L.marker([college.lat, college.lon]).addTo(map);
        marker.bindPopup(`
          <b>${college.tags.name || "Unnamed College"}</b><br>
          ‚≠ê Placement: ${college.placement}%<br>
          üí∞ Fees: ‚Çπ${college.fees.toLocaleString()}<br>
          üèÜ NAAC: ${college.naac}<br>
          üè´ Type: ${college.type}
        `);
        markers.push(marker);
      });
    }

    function applyFilter() {
      const filter = document.getElementById("filterOption").value;
      if (!collegeData.length) {
        alert("‚ö†Ô∏è Please search for colleges first!");
        return;
      }

      let sortedData = [...collegeData];

      if (filter === "placement") {
        sortedData.sort((a, b) => b.placement - a.placement);
      } else if (filter === "fees") {
        sortedData.sort((a, b) => a.fees - b.fees);
      } else if (filter === "naac") {
        const gradeOrder = { "A++": 1, "A+": 2, "A": 3, "B+": 4, "B": 5 };
        sortedData.sort((a, b) => gradeOrder[a.naac] - gradeOrder[b.naac]);
      } else if (filter === "type") {
        const typeOrder = { "Government": 1, "Autonomous": 2, "Private": 3 };
        sortedData.sort((a, b) => typeOrder[a.type] - typeOrder[b.type]);
      }

      displayColleges(sortedData);
      addMarkers(sortedData);
    }

    function useMyLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            findColleges(null, lat, lon);
          },
          error => {
            alert("‚ö†Ô∏è Unable to fetch your location. Please allow location access.");
            console.error(error);
          }
        );
      } else {
        alert("‚ùå Geolocation is not supported by your browser.");
      }
    }
  </script>

</body>
</html>
